{% extends "layout.html" %} {% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand font-weight-bold" href="#">Orders</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{url_for('products')}}">
              Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{url_for('logout')}}">
              <i class="mdi mdi-logout" aria-hidden="true"></i>
              Logout</a>
          </li>
        </ul>
    </div>
</div>
</nav>
<ul class="nav nav-tabs mt-2 ml-1">
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'failed' %} active {%endif%}" href="{{url_for('woocom_orders', status='failed')}}">Failed</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'processing' %} active {%endif%}" href="{{url_for('woocom_orders', status='processing')}}">Processing</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'tbd-paid, tbd-unpaid' %} active {%endif%}" href="{{url_for('woocom_orders', status='tbd-paid, tbd-unpaid')}}">To Be Delivered</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'subscription' %} active {%endif%}" href="{{url_for('woocom_orders', status='subscription')}}">Subscription</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'delivered-unpaid' %} active {%endif%}" href="{{url_for('woocom_orders', status='delivered-unpaid')}}">Delivered Unpaid</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'completed' %} active {%endif%}" href="{{url_for('woocom_orders', status='completed')}}">Delivered Paid</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'refunded' %} active {%endif%}" href="{{url_for('woocom_orders', status='refunded')}}">Refunded</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'cancelled' %} active {%endif%}" href="{{url_for('woocom_orders', status='cancelled')}}">Cancelled</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if nav_active == 'any' %} active {%endif%}" href="{{url_for('woocom_orders', status='any')}}">All</a>
  </li>
</ul>
<div  class="mt-3 ml-3 mr-3">
    <form autocomplete="off" class = "form-inline" role = "form">
      <input style="display: none;" name="page" value="{{page}}">
      {% if nav_active != '' %}
        <input style="display: none;" name="status" value="{{nav_active}}">
      {% endif %}
      <select data-live-search="true" multiple title="Order ID" name="order_ids" class="selectpicker mr-2">
        {% for o in orders %}
        <option {% if "order_ids" in query %} {% if o.id|string in query["order_ids"] %} selected {% endif %} {% endif %}>{{o.id}}</option>
        {% endfor%}
      </select>
      <select title="Payment Status" name="payment_status" class="selectpicker mr-2">
        <option value="">Payment Status</option>
        <option {% if "payment_status" in query %} {% if query.payment_status[0] == "paid" %} selected {% endif %} {% endif %} value="paid">Paid</option>
        <option {% if "payment_status" in query %} {% if query.payment_status[0] == "unpaid" %} selected {% endif %} {% endif %} value="unpaid">Unpaid</option>
      </select>
      <input class="form-control mr-2" type="phone" placeholder="Phone Number" {% if "phone_number" in query %} {% if query["phone_number"][0] != "" %} value="{{query["phone_number"][0]}}" {% endif %} {% endif %} name="phone_number">
      <input class="form-control mr-2" type="name" placeholder="Name" {% if "name" in query %} {% if query["name"][0] != "" %} value="{{query["name"][0]}}" {% endif %} {% endif %} name="name">
      <select data-live-search="true" multiple title="Vendor" name="vendor" class="selectpicker mr-2">
        {% for v in vendors %}
        {% if v != ""%}
          <option {% if "vendor" in query %} {% if v in query["vendor"] %} selected {% endif %} {% endif %}>{{v}}</option>
        {% else %}
          <option {% if "vendor" in query %} {% if v in query["vendor"] %} selected {% endif %} {% endif %} value="">Null</option>
        {%endif%}
        {% endfor%}
      </select>      <select data-live-search="true" multiple title="Manager" name="manager" class="selectpicker mr-2">
        {% for m in managers %}
        {% if m != ""%}
          <option {% if "manager" in query %} {% if m in query["manager"] %} selected {% endif %} {% endif %}>{{m}}</option>
        {%endif%}
        {% endfor%}
      </select>
      <select data-live-search="true" multiple title="Created Via" name="created_via" class="selectpicker mr-2">
        {% for v in list_created_via %}
        {% if v != ""%}
          {% if nav_active == "tbd-paid, tbd-unpaid" %}
            {% if v != "subscription" %}
              <option {% if "created_via" in query %} {% if v in query["created_via"] %} selected {% endif %} {% endif %}>{{v}}</option>
            {%endif%}
          {% elif nav_active == "subscription" %}
              {% if v == "subscription"%}
              <option {% if "created_via" in query %} {% if v in query["created_via"] %} selected {% endif %} {% endif %}>{{v}}</option>
              {%endif%}
          {% else %}
          <option {% if "created_via" in query %} {% if v in query["created_via"] %} selected {% endif %} {% endif %}>{{v}}</option>
        {%endif%}
        {%endif%}
        {% endfor%}
      </select>
      <input placeholder="Delivery Date" type="text" name="delivery_date" id="datepicker" class="form-control mr-2" {% if "delivery_date" in query %} {% if query["delivery_date"][0] != "" %} value="{{query["delivery_date"][0]}}" {% endif %} {% endif %}>
      <button class="btn btn-info ml-1"><i class="mdi mdi-18px mdi-filter-variant" aria-hidden="true"></i>
      </button>
    </form>
    <form autocomplete="off" action="{{url_for('download_csv')}}", method="POST" class = "form-inline mt-2" role = "form">
      {% if nav_active != '' %}
        <input style="display: none;" name="status" value="{{nav_active}}">
      {% endif %}
      <select data-live-search="true" multiple required title="Order ID" name="order_ids" class="selectpicker mr-2">
        {% for o in orders %}
        <option value="{{o.id}}">{{o.id}} - {{ o.billing.first_name}} - 
          {{o.vendor}}
        </option>
        {% endfor%}
      </select>
      <button class="btn btn-info"><i class="mdi mdi-18px mdi-progress-download" aria-hidden="true"></i>
      </form>
</div>
<div style="overflow-x: auto;" class="ml-1 mr-1 pt-3">
  <table class="table">
    <thead>
      <tr class="bg-info text-white">
        <th scope="col"></th>
        <th scope="col">Order ID</th>
        <th scope="col">Customer Name (Phone_Number)</th>
        <th scope="col">City</th>
        <th scope="col">Status</th>
        <th scope="col">Payment Status (Payment_Type)</th>
        <th scope="col">Order Date</th>
        <th scope="col">Delivery Date</th>
        <th scope="col">Amount</th>
        <th scope="col">Refund</th>
        <th scope="col">Amount Payble</th>
        <th scope="col">Whatsapp Messages</th>
        <th scope="col">Vendor</th>
        <th scope="col">Manager</th>
        <!-- <th scope="col">Wallet Balance</th> -->
        <th scope="col">Created VIA</th>
        <th scope="col">Checkout URL</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr>
        <td class="{{o.id}}"scope="row">
          {% if o.vendor_type %}
          <div style="min-width: 92px;">
            <i title="Supplier Message" onclick="copyToClipboard('s_msg_{{o.id}}')" class="mdi mdi-18px mdi-content-copy btn-sm btn btn-warning"style="cursor: pointer;" aria-hidden="true"></i>
            <i title="Order Detail Message" onclick="copyToClipboard('c_msg_{{o.id}}')" class="mdi mdi-18px mdi-content-copy btn-sm btn btn-warning ml-1"style="cursor: pointer;" aria-hidden="true"></i>
          </div>
          {% endif %}
          <div class="mt-1">
          {% if nav_active == "processing"%}
          {% if o.vendor_type %}
          <div style="min-width: 125px;">
              <a class="btn btn-success btn-sm" href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='hello_msg', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key, page=page)}}')
              ">
                <i title="Hello Message" class="mdi mdi-18px mdi-whatsapp"></i>
              </a>
              <a class="btn btn-success btn-sm ml-1" href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='order_detail_msg', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key, page=page)}}')
              ">
                <i title="Order Detail Message" class="mdi mdi-18px mdi-whatsapp"></i>
              </a>
              {% if o.date_paid == None %}
              <a class="btn btn-success btn-sm ml-1" href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='postpay_msg', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key, page=page)}}')
              ">
              <i title="Postpay Message" class="mdi mdi-18px mdi-whatsapp"></i>
            </a>
            {% else %}
            <a class="btn btn-success btn-sm ml-1" href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='prepay_msg', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key, page=page)}}')
            ">
            <i title="Prepay Message" class="mdi mdi-18px mdi-whatsapp"></i>
            </a>
          </button>
          </div>
          {% endif %}
          {%endif%}
          {% endif %}
          {% if nav_active == "tbd-paid, tbd-unpaid" or nav_active == "subscription"%}
          {% if o.vendor_type and o.delivery_date and o.payment_method %}
          {% if o.date_paid != None %}
           <div class="mb-1" style="min-width: 1120px40px;">
              <a title="Delivery Today Message" class="btn btn-success btn-sm"  
              href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, order_note=o.order_note, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='today_prepay', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key,url_post_pay=o.checkout_url[39:], page=page)}}')
              ">Today
              </a>
            <a title="Delivery Tomorrow Message" class="btn btn-success btn-sm ml-1" 
            href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, order_note=o.order_note, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='tomorrow_prepay', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key,url_post_pay=o.checkout_url[39:], page=page)}}')
              ">Tom
            </a>
            </div>
            <div style="min-width: 120px;">
                <a title="Order Detail Message" class="btn btn-success btn-sm" 
                href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, order_note=o.order_note, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='order_prepay', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key,url_post_pay=o.checkout_url[39:], page=page)}}')
                  ">Order
                </a>
            </div>
            {%else%}
            <div class="mb-1" style="min-width: 1120px40px;">
              <a title="Delivery Today Message" class="btn btn-success btn-sm"  
              href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, order_note=o.order_note, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='today_postpay', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key,url_post_pay=o.checkout_url[39:], page=page)}}')
              ">Today
              </a>
            <a title="Delivery Tomorrow Message" class="btn btn-success btn-sm ml-1" 
            href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, order_note=o.order_note, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='tomorrow_postpay', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key,url_post_pay=o.checkout_url[39:], page=page)}}')
              ">Tom
            </a>
            </div>
            <div style="min-width: 120px;">
                <a title="Order Detail Message" class="btn btn-success btn-sm" 
                href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, order_note=o.order_note, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='order_postpay', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key,url_post_pay=o.checkout_url[39:], page=page)}}')
                  ">Order
                </a>
            </div>
            {%endif%}
          {%endif%}
          {% endif %}
          {% if nav_active == "delivered-unpaid"%}
          {% if o.vendor_type %}
              <div style="min-width: 92px;">
               <a class="btn btn-success btn-sm" href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='feedback_msg', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key, page=page)}}')
               ">
                <i title="Feedback Message" class="mdi mdi-18px mdi-whatsapp" aria-hidden="true"></i>
               </a>
               <a class="btn btn-success btn-sm ml-1" href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='payment_remainder_msg', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key, page=page)}}')
               ">
                <i title="Payment Reminder Message" class="mdi mdi-18px mdi-whatsapp" aria-hidden="true"></i>
               </a>
              </div>
              {%endif%}
          {% endif %}
          {% if nav_active == "completed"%}
          {% if o.vendor_type %}
              <a class="btn btn-success btn-sm" href="{{url_for('send_whatsapp', c_name = o.billing.first_name, manager=o.manager, order_id = o.id, total_amount=o.total, delivery_date=o.delivery_date, payment_method=o.payment_method_title, delivery_charge=o.shipping_total, seller=o.vendor, items_amount=o.total|float-o.shipping_total|float, name='feedback_msg', status=nav_active, vendor_type=o.vendor_type, mobile_number=o.billing.phone, order_key=o.order_key, page=page)}}')
              ">
                <i title="Feedback Message" class="mdi mdi-18px mdi-whatsapp" aria-hidden="true"></i>
              </a>
              {%endif%}
          {% endif %}
          
          <p style="display: none;" id="c_msg_{{o.id}}">
            {{o.c_msg}}
          </p>
          <p style="display: none;" id="s_msg_{{o.id}}">
            {{o.s_msg}}
          </p>
          </div>
        </td>
        <td scope="row">{{ o.id}}</td>
        <td scope="row">{{ o.billing.first_name}} {{ o.billing.last_name}} ({{ o.billing.phone}})</td>
        <td scope="row">{{ o.billing.city}}</td>
        <td scope="row">{{ o.status}}</td>
        {% if o.date_paid == None %}
            <td scope="row">Unpaid ({{ o.payment_method}})</td>
            {% else %}
            <td scope="row">Paid ({{ o.payment_method}})</td>
        {% endif %}
        <td scope="row">{{ o.date_created}}</td>
        <td scope="row">{{ o.delivery_date}}</td>
        <td scope="row">{{ o.total}}</td>
        <td scope="row">{{ o.total_refunds}}</td>
        <td scope="row">{{ o.total-o.total_refunds}}</td>
        <td class="wtmessage-{{o.id}}" scope="row">
          <div style="max-height: 100px; overflow-y: scroll;">
          {% for wt in wtmessages_list[o.id]%}
            {% if wt.status == "success"%}
              <span class="text-success">{{wt.template_name}}, </span>
            {%else%}
              <span class="text-danger">{{wt.template_name}}, </span>
            {% endif%}
          {% endfor %}
          </div>
        </td>
        <td scope="row">
          {{o.vendor}}
        </td>
        <td scope="row">
        {{o.manager}}
        </td>
        <!-- <td scope="row">
          {{o.wallet_balance}}
          </td> -->
        <td scope="row">
          {{o.created_via}}
          </td>
        <td scope="row">
          <a style="font-size: 15px;" target="blank" href="{{o.checkout_url}}">{{o.checkout_url}}</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<br /><br />
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page == 1%} disabled {%endif%}">
      <a class="page-link" href="{{url_for('woocom_orders', page=page-1, order_ids = query['order_ids'], payment_status=query['payment_status'], phone_number=query['phone_number'], name=query['name'], vendor=query['vendor'], manager=query['manager'], created_via=query['created_via'], delivery_date=query['delivery_date'], status=nav_active)}}" tabindex="-1"
        >Previous</a
      >
    </li>
    <li class="page-item">
      <a class="page-link">{{page}}</a>
    </li>
    <li class="page-item {% if orders | length != 50%} disabled {%endif%}">
      <a class="page-link" href="{{url_for('woocom_orders', page=page+1, order_ids = query['order_ids'], payment_status=query['payment_status'], phone_number=query['phone_number'], name=query['name'], vendor=query['vendor'], manager=query['manager'], created_via=query['created_via'], delivery_date=query['delivery_date'], status=nav_active)}}">Next</a>
    </li>
  </ul>
</nav>
<script>
  function copyToClipboard(id) {
   var tag = document.getElementById(""+id+"")
   var text = tag.innerHTML.trim()
   text = text.replace("&amp;", "&")
   var input = document.body.appendChild(document.createElement("textarea"));
   input.value = text;
   input.select();
   var status = document.execCommand("copy");
   input.parentNode.removeChild(input);
   if (status) {
    $.nok({
      message: "Success, Message Copied!",
      type: "success",
    });
   }else{
    $.nok({
      message: "Error, Message Not Copied!",
      type: "error",
    });
   }
 }
 {% if "message_sent" in query%}
 $("html, body").animate({
        scrollTop: $(".{{query["message_sent"][0]}}").offset().top,
    });
    {%endif%}
 </script>
 
{% endblock %}
